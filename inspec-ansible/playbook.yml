---
- name: Create an EC2 instance to run Inspec tests on
  hosts: localhost
  gather_facts: false
  connection: local
  vars:
    key_pair_name: "{{ ec2_key_pair_name }}"
    instance_type: t2.micro
    security_group: allow_ssh_for_inspec
    ami_id: "{{ packer_ami_id }}"
    region: "{{ aws_region }}"
  tasks:

  - name: Create a security group to allow SSH access for Inspec tests
    local_action:
      module: ec2_group
      name: "{{ security_group }}"
      description: Security Group for webserver Servers
      region: "{{ region }}"
      rules:
        - proto: tcp
          from_port: 22
          to_port: 22
          cidr_ip: 0.0.0.0/0
      rules_egress:
        - proto: all
          cidr_ip: 0.0.0.0/0
    register: allow_ssh

  - name: Launch instance
    ec2:
       key_name: "{{ key_pair_name }}"
       group: "{{ security_group }}"
       instance_type: "{{ instance_type }}"
       image: "{{ ami_id }}"
       wait: true
       region: "{{ region }}"
       assign_public_ip: yes
    register: ec2

  - name: Wait for SSH to come up
    wait_for:
      host: "{{ item.public_dns_name }}"
      port: 22
      delay: 30
      timeout: 120
      state: started
    with_items: "{{ ec2.instances }}"
    vars:
      ansible_connection: local

  - name: Create instance information output file
    command: "echo {{ ec2.instances[0].public_dns_name }}"
